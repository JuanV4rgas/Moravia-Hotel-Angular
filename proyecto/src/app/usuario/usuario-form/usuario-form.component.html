<!-- Header -->
<div class="page-header">
  <h2>
    <i class="bi" [ngClass]="isEdit ? 'bi-pencil-square' : 'bi-person-plus'"></i>
    {{ isEdit ? 'Editar Usuario' : 'Nuevo Usuario' }}
  </h2>
</div>

<!-- Loading -->
<div *ngIf="loading && isEdit" class="container text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-3">Cargando información del usuario...</p>
</div>

<!-- Formulario -->
<main class="container pb-5" *ngIf="!loading || !isEdit">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card form-card">
        
        <!-- Mensajes -->
        <div *ngIf="mensaje" class="alert alert-success alert-dismissible fade show">
          {{ mensaje }}
          <button type="button" class="btn-close" (click)="mensaje = ''"></button>
        </div>
        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
          {{ error }}
          <button type="button" class="btn-close" (click)="error = ''"></button>
        </div>

        <!-- Formulario -->
        <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" novalidate>
          
          <!-- Información Personal -->
          <section class="mb-4">
            <h4 class="section-title">
              <i class="bi bi-person me-2"></i> Información Personal
            </h4>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="nombre" class="form-label">Nombres*</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  formControlName="nombre"
                  placeholder="Juan"
                  required
                />
                <div *ngIf="usuarioForm.get('nombre')?.invalid && usuarioForm.get('nombre')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('nombre')?.errors?.['required']">El nombre es requerido.</span>
                  <span *ngIf="usuarioForm.get('nombre')?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres.</span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="apellido" class="form-label">Apellidos*</label>
                <input
                  type="text"
                  class="form-control"
                  id="apellido"
                  formControlName="apellido"
                  placeholder="Pérez"
                  required
                />
                <div *ngIf="usuarioForm.get('apellido')?.invalid && usuarioForm.get('apellido')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('apellido')?.errors?.['required']">El apellido es requerido.</span>
                  <span *ngIf="usuarioForm.get('apellido')?.errors?.['minlength']">El apellido debe tener al menos 2 caracteres.</span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="email" class="form-label">Correo*</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  placeholder="juan.perez@ejemplo.com"
                  required
                />
                <div *ngIf="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('email')?.errors?.['required']">El email es requerido.</span>
                  <span *ngIf="usuarioForm.get('email')?.errors?.['email']">Ingresa un email válido.</span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="cedula" class="form-label">Cédula*</label>
                <input
                  type="text"
                  class="form-control"
                  id="cedula"
                  formControlName="cedula"
                  placeholder="1234567890"
                  required
                />
                <div *ngIf="usuarioForm.get('cedula')?.invalid && usuarioForm.get('cedula')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('cedula')?.errors?.['required']">La cédula es requerida.</span>
                  <span *ngIf="usuarioForm.get('cedula')?.errors?.['pattern']">La cédula debe tener exactamente 10 dígitos.</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Información de Contacto -->
          <section class="mb-4">
            <h4 class="section-title">
              <i class="bi bi-telephone me-2"></i> Información de Contacto
            </h4>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono*</label>
                <input
                  type="tel"
                  class="form-control"
                  id="telefono"
                  formControlName="telefono"
                  placeholder="3001234567"
                />
                <div *ngIf="usuarioForm.get('telefono')?.invalid && usuarioForm.get('telefono')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('telefono')?.errors?.['pattern']">El teléfono debe tener entre 7 y 15 dígitos.</span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="fotoPerfil" class="form-label">URL Foto de Perfil</label>
                <input
                  type="url"
                  class="form-control"
                  id="fotoPerfil"
                  formControlName="fotoPerfil"
                  placeholder="https://ejemplo.com/foto.jpg"
                />
                <small class="form-text">Deja en blanco para usar avatar por defecto</small>
              </div>

              <div class="col-md-6">
                <label for="tipo" class="form-label">Tipo de usuario*</label>
                <select id="tipo" class="form-select" formControlName="tipo" required>
                  <option value="cliente">Cliente</option>
                  <option value="administrador">Administrador</option>
                  <option value="operador">Operador</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Seguridad -->
          <section class="mb-4">
            <h4 class="section-title">
              <i class="bi bi-shield-lock me-2"></i> {{ isEdit ? 'Cambiar Contraseña (opcional)' : 'Contraseña*' }}
            </h4>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="clave" class="form-label">{{ isEdit ? 'Nueva Contraseña' : 'Contraseña*' }}</label>
                <div class="input-group">
                  <input
                    [type]="mostrarClave ? 'text' : 'password'"
                    class="form-control"
                    id="clave"
                    formControlName="clave"
                    placeholder="••••••••"
                    [attr.required]="!isEdit ? true : null"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="togglePassword('clave')"
                  >
                    <i
                      class="bi"
                      [ngClass]="mostrarClave ? 'bi-eye' : 'bi-eye-slash'"
                    ></i>
                  </button>
                </div>
                <div *ngIf="usuarioForm.get('clave')?.invalid && usuarioForm.get('clave')?.touched" class="text-danger mt-1">
                  <span *ngIf="usuarioForm.get('clave')?.errors?.['required']">La contraseña es requerida.</span>
                  <span *ngIf="usuarioForm.get('clave')?.errors?.['minlength']">La contraseña debe tener al menos 8 caracteres.</span>
                </div>
              </div>

              <div class="col-md-6">
                <label for="confirmarClave" class="form-label">{{ isEdit ? 'Confirmar Nueva Contraseña' : 'Confirmar Contraseña*' }}</label>
                <div class="input-group">
                  <input
                    [type]="mostrarConfirmarClave ? 'text' : 'password'"
                    class="form-control"
                    id="confirmarClave"
                    formControlName="confirmarClave"
                    placeholder="••••••••"
                    [attr.required]="!isEdit ? true : null"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="togglePassword('confirmar')"
                  >
                    <i
                      class="bi"
                      [ngClass]="mostrarConfirmarClave ? 'bi-eye' : 'bi-eye-slash'"
                    ></i>
                  </button>
                </div>
                <div *ngIf="usuarioForm.get('confirmarClave')?.hasError('mismatch')" class="text-danger mt-1">
                  Las contraseñas no coinciden.
                </div>
                <div *ngIf="usuarioForm.get('confirmarClave')?.hasError('minlength') && usuarioForm.get('confirmarClave')?.touched" class="text-danger mt-1">
                  La contraseña debe tener al menos 8 caracteres.
                </div>
                <div *ngIf="usuarioForm.get('confirmarClave')?.hasError('required') && usuarioForm.get('confirmarClave')?.touched" class="text-danger mt-1">
                  Debes confirmar la contraseña.
                </div>
              </div>
            </div>
          </section>

          <!-- Botones -->
          <div class="d-flex justify-content-between flex-wrap gap-2 mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="resetForm()"
              [disabled]="!formChanged"
            >
              <i class="bi bi-arrow-clockwise me-1"></i> Restaurar
            </button>

            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="cancelar()"
              >
                <i class="bi bi-x-lg me-1"></i> Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="!formChanged || usuarioForm.invalid || loading"
              >
                <i class="bi" [ngClass]="isEdit ? 'bi-check-lg' : 'bi-plus-lg'"></i>
                {{ loading ? 'Guardando...' : (isEdit ? 'Actualizar' : 'Crear Usuario') }}
              </button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</main>